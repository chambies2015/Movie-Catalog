<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Movie Tracker</title>
  <style>
    :root {
      --bg: #f7f9fc;
      --fg: #2a2a2a;
      --card-bg: #ffffff;
      --primary: #3f51b5;
      --primary-hover: #303f9f;
      --table-header-bg: #3f51b5;
      --table-row-alt: #f2f2f2;
      --btn-radius: 4px;
    }
    body.dark-mode {
      --bg: #1e1e2f;
      --fg: #e0e0e0;
      --card-bg: #2c2c3e;
      --primary: #3949ab;
      --primary-hover: #303f9f;
      --table-header-bg: #3949ab;
      --table-row-alt: #2a2a3b;
    }
    body {
      background-color: var(--bg);
      color: var(--fg);
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    .toggle-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 6px 12px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--btn-radius);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .toggle-btn:hover {
      background-color: var(--primary-hover);
    }
    h1 {
      margin-top: 0;
      margin-bottom: 20px;
    }
    .card {
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    .card h2 {
      margin-top: 0;
    }
    input[type="text"], input[type="number"], select {
      padding: 8px;
      margin: 4px 0;
      border: 1px solid #ccc;
      border-radius: var(--btn-radius);
      width: calc(100% - 22px);
      background-color: var(--card-bg);
      color: var(--fg);
    }
    body.dark-mode input, body.dark-mode select {
      border-color: #555;
    }
    label {
      display: inline-block;
      margin-right: 10px;
    }
    button.action-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--btn-radius);
      padding: 8px 12px;
      cursor: pointer;
      margin-right: 5px;
      margin-top: 8px;
      min-width: 80px;
    }
    button.action-btn:hover {
      background-color: var(--primary-hover);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      border: 1px solid #ddd;
    }
    th {
      background-color: var(--table-header-bg);
      color: white;
    }
    tr:nth-child(even) td {
      background-color: var(--table-row-alt);
    }
    tr:hover td {
      background-color: rgba(0,0,0,0.02);
    }
  </style>
</head>
<body>
  <button id="toggleMode" class="toggle-btn">Night Mode</button>
  <div class="container">
    <h1>Movie Tracker</h1>
    <div class="card">
      <h2>Add Movie</h2>
      <form id="addForm">
        <div>
          <input type="text" id="title" placeholder="Title" required>
        </div>
        <div>
          <input type="text" id="director" placeholder="Director" required>
        </div>
        <div>
          <input type="number" id="year" placeholder="Year" required>
        </div>
        <div>
          <input type="number" step="0.1" id="rating" placeholder="Rating" required>
        </div>
        <div>
          <label>Watched <input type="checkbox" id="watched"></label>
        </div>
        <button type="submit" class="action-btn">Add</button>
      </form>
    </div>

    <div class="card">
      <h2>Movies</h2>
      <div style="display:flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
        <input type="text" id="search" placeholder="Search by title or director" style="flex: 2; min-width: 200px;">
        <select id="sort" style="flex: 1; min-width: 140px;">
          <option value="">Sort by...</option>
          <option value="rating">Rating</option>
          <option value="year">Year</option>
        </select>
        <button id="loadMovies" class="action-btn" style="flex: 1; min-width: 120px;">Load Movies</button>
      </div>
      <div style="overflow-x:auto;">
        <table id="moviesTable">
          <thead>
            <tr>
              <th style="width:5%;">ID</th>
              <th style="width:25%;">Title</th>
              <th style="width:20%;">Director</th>
              <th style="width:10%;">Year</th>
              <th style="width:10%;">Rating</th>
              <th style="width:10%;">Watched</th>
              <th style="width:10%;">IMDb</th>
              <th style="width:20%;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Toggle night mode
    const toggleButton = document.getElementById('toggleMode');
    toggleButton.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      if (document.body.classList.contains('dark-mode')) {
        toggleButton.textContent = 'Light Mode';
      } else {
        toggleButton.textContent = 'Night Mode';
      }
    });

    const apiBase = 'http://127.0.0.1:8000';

    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const movie = {
        title: document.getElementById('title').value,
        director: document.getElementById('director').value,
        year: parseInt(document.getElementById('year').value),
        rating: parseFloat(document.getElementById('rating').value),
        watched: document.getElementById('watched').checked
      };
      const res = await fetch(`${apiBase}/movies/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(movie)
      });
      if(res.ok) {
        loadMovies();
        e.target.reset();
      } else {
        const msg = await res.text();
        alert('Error adding movie: ' + msg);
      }
    });

    async function loadMovies() {
      const search = document.getElementById('search').value;
      const sort = document.getElementById('sort').value;
      const params = new URLSearchParams();
      if(search) params.append('search', search);
      if(sort) params.append('sort_by', sort);
      const res = await fetch(`${apiBase}/movies/?${params.toString()}`);
      if(!res.ok) {
        const msg = await res.text();
        alert('Error loading movies: ' + msg);
        return;
      }
      const data = await res.json();
      const tbody = document.getElementById('moviesTable').querySelector('tbody');
      tbody.innerHTML = '';
      data.forEach(movie => {
        const imdbLink = 'https://www.imdb.com/find?q=' + encodeURIComponent(movie.title);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${movie.id}</td>
          <td>${movie.title}</td>
          <td>${movie.director}</td>
          <td>${movie.year}</td>
          <td>${movie.rating}</td>
          <td>${movie.watched}</td>
          <td><a href="${imdbLink}" target="_blank">Search</a></td>
          <td>
            <button class="action-btn" onclick="startEdit(${movie.id})">Edit</button>
            <button class="action-btn" onclick="deleteMovie(${movie.id})">Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    document.getElementById('loadMovies').addEventListener('click', loadMovies);

    async function deleteMovie(id) {
      if(!confirm('Delete movie?')) return;
      const res = await fetch(`${apiBase}/movies/${id}`, { method: 'DELETE' });
      if(res.ok) {
        loadMovies();
      } else {
        const msg = await res.text();
        alert('Error deleting movie: ' + msg);
      }
    }

    let editId = null;

    function startEdit(id) {
      editId = id;
      const tbody = document.getElementById('moviesTable').querySelector('tbody');
      const rows = Array.from(tbody.children);
      const row = rows.find(r => r.children[0].textContent == id);
      if(!row) return;
      const cells = row.children;
      const formRow = document.createElement('tr');
      formRow.innerHTML = `
        <td>${id}</td>
        <td><input type="text" id="editTitle" value="${cells[1].textContent}" style="width:95%; padding:6px;"></td>
        <td><input type="text" id="editDirector" value="${cells[2].textContent}" style="width:90%; padding:6px;"></td>
        <td><input type="number" id="editYear" value="${cells[3].textContent}" style="width:80%; padding:6px;"></td>
        <td><input type="number" step="0.1" id="editRating" value="${cells[4].textContent}" style="width:80%; padding:6px;"></td>
        <td><input type="checkbox" id="editWatched" ${cells[5].textContent == 'true' ? 'checked' : ''}></td>
        <td>${cells[6].innerHTML}</td>
        <td>
          <button class="action-btn" onclick="saveEdit()" style="margin-bottom:4px;">Save</button>
          <button class="action-btn" onclick="cancelEdit()">Cancel</button>
        </td>
      `;
      tbody.replaceChild(formRow, row);
    }

    async function saveEdit() {
      if(editId === null) return;
      const movieUpdate = {};
      movieUpdate.title = document.getElementById('editTitle').value;
      movieUpdate.director = document.getElementById('editDirector').value;
      movieUpdate.year = parseInt(document.getElementById('editYear').value);
      movieUpdate.rating = parseFloat(document.getElementById('editRating').value);
      movieUpdate.watched = document.getElementById('editWatched').checked;
      const res = await fetch(`${apiBase}/movies/${editId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(movieUpdate)
      });
      if(res.ok) {
        editId = null;
        loadMovies();
      } else {
        const msg = await res.text();
        alert('Error updating movie: ' + msg);
      }
    }

    function cancelEdit() {
      editId = null;
      loadMovies();
    }

    // Load movies initially
    loadMovies();
  </script>
</body>
</html>
