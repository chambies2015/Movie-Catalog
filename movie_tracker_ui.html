<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Movie Tracker</title>
  <style>
    :root {
      /* Light mode colour palette */
      --bg: #f7f9fc;
      --fg: #2a2a2a;
      --card-bg: #ffffff;
      --primary: #3f51b5;
      --primary-hover: #303f9f;
      --table-header-bg: #3f51b5;
      --table-row-alt: #f2f2f2;
      --btn-radius: 4px;
    }

    /* Dark mode overrides. Only card colours and text colours change. */
    body.dark-mode {
      --bg: #1e1e2f;
      --fg: #e0e0e0;
      --card-bg: #2c2c3e;
      --primary: #3949ab;
      --primary-hover: #303f9f;
      --table-header-bg: #3949ab;
      --table-row-alt: #2a2a3b;
    }

    body {
      /* Use the same movieâ€‘theatre backdrop for both light and dark modes */
      background-image: url('movie_theater_background.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-color: var(--bg);
      color: var(--fg);
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    /* Film strip header remains unchanged */
    .header {
      height: 200px;
      margin-bottom: 20px;
      border-radius: 8px;
      background-image: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('film_background.jpg');
      background-size: cover;
      background-position: center;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .header h1 {
      font-size: 3rem;
      color: #fff;
      margin: 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .toggle-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 6px 12px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--btn-radius);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .toggle-btn:hover {
      background-color: var(--primary-hover);
    }

    .card {
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    input[type="text"], input[type="number"], select {
      padding: 8px;
      margin: 4px 0;
      border: 1px solid #ccc;
      border-radius: var(--btn-radius);
      width: calc(100% - 22px);
      background-color: var(--card-bg);
      color: var(--fg);
    }
    body.dark-mode input, body.dark-mode select {
      border-color: #555;
    }

    label {
      display: inline-block;
      margin-right: 10px;
    }

    button.action-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--btn-radius);
      padding: 8px 12px;
      cursor: pointer;
      margin-right: 5px;
      margin-top: 8px;
      min-width: 80px;
    }
    button.action-btn:hover {
      background-color: var(--primary-hover);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      /* Prevent column widths from changing when a row enters edit mode */
      table-layout: fixed;
    }
    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      /* Center cell contents vertically to avoid row height jumps when inputs are inserted */
      vertical-align: middle;
    }
    th {
      background-color: var(--table-header-bg);
      color: white;
    }
    tr:nth-child(even) td {
      background-color: var(--table-row-alt);
    }
    tr:hover td {
      background-color: rgba(0,0,0,0.02);
    }

    /* Adjust input styles inside the table for inline editing.  Without this,
       the default form styling causes table rows to expand vertically when
       editing.  These rules ensure the inputs occupy the full cell width
       without extra margin or padding. */
    table input[type="text"],
    table input[type="number"] {
      margin: 0;
      /* Keep padding minimal so the input height matches the default cell height. */
      padding: 4px;
      width: 100%;
      box-sizing: border-box;
      /* Inherit font styles so the input text matches the table text. */
      font: inherit;
      /* Ensure borders do not expand the row height unexpectedly. */
      border: 1px solid #ccc;
      border-radius: var(--btn-radius);
    }
    table input[type="checkbox"] {
      margin: 0 auto;
      display: block;
    }

    /* Disabled buttons should appear muted and unclickable */
    button.action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Responsive table layout */
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }
      tr {
        margin-bottom: 10px;
      }
      td {
        border: none;
        position: relative;
        padding-left: 50%;
      }
      td:before {
        position: absolute;
        top: 12px;
        left: 6px;
        width: 45%;
        white-space: nowrap;
      }
      td:nth-of-type(1):before { content: "ID"; }
      td:nth-of-type(2):before { content: "Title"; }
      td:nth-of-type(3):before { content: "Director"; }
      td:nth-of-type(4):before { content: "Year"; }
      td:nth-of-type(5):before { content: "Rating"; }
      td:nth-of-type(6):before { content: "Watched"; }
      td:nth-of-type(7):before { content: "IMDb"; }
      td:nth-of-type(8):before { content: "Actions"; }
    }
  </style>
</head>
<body>
  <!-- Dark/light toggle -->
  <button id="toggleMode" class="toggle-btn">Night Mode</button>
  <div class="container">
    <div class="header">
      <h1>Movie Tracker</h1>
    </div>
    <div class="card">
      <h2>Add Movie</h2>
      <form id="addForm">
        <div>
          <input type="text" id="title" placeholder="Title" required>
        </div>
        <div>
          <input type="text" id="director" placeholder="Director" required>
        </div>
        <div>
          <input type="number" id="year" placeholder="Year" required>
        </div>
        <div>
          <input type="number" step="0.1" id="rating" placeholder="Rating">
        </div>
        <div>
          <label>Watched <input type="checkbox" id="watched"></label>
        </div>
        <button type="submit" class="action-btn">Add</button>
      </form>
    </div>
    <div class="card">
      <h2>Movies</h2>
      <div style="display:flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
        <input type="text" id="search" placeholder="Search by title or director" style="flex: 2; min-width: 200px;">
        <select id="sort" style="flex: 1; min-width: 140px;">
          <option value="">Sort by...</option>
          <option value="rating">Rating</option>
          <option value="year">Year</option>
        </select>
        <button id="loadMovies" class="action-btn" style="flex: 1; min-width: 120px;">Load Movies</button>
      </div>
      <table id="movieTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Director</th>
            <th>Year</th>
            <th>Rating</th>
            <th>Watched</th>
            <th>IMDb</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <script>
    // Determine the API base URL.  When opening from a file (file://),
    // location.origin is "null" in most browsers.  For those cases, or when
    // there is no origin, default to the local FastAPI backend running on
    // port 8000.  Otherwise, use relative paths to the hosting origin.
    const isLocal = (location.protocol === 'file:' || location.origin === 'null' || location.origin === '');
    const API_BASE = isLocal ? 'http://127.0.0.1:8000' : '';

    // Track row being edited inline
    let editingRowId = null;
    let editingRowElement = null;

    /**
     * Disable all Edit/Delete buttons in the movie table except those
     * associated with the row currently being edited.  This prevents
     * starting another edit while one is in progress.
     * @param {HTMLTableRowElement} currentRow The row being edited
     */
    function disableOtherRowButtons(currentRow) {
      const buttons = document.querySelectorAll('#movieTable button.action-btn');
      buttons.forEach(btn => {
        // Determine the row for each button.  Only disable buttons
        // belonging to rows other than the current editing row.
        const btnRow = btn.closest('tr');
        if (!btnRow.isSameNode(currentRow)) {
          btn.disabled = true;
        }
      });
    }

    /**
     * Re-enable all buttons in the movie table.  Should be called
     * after an edit is saved or cancelled.
     */
    function enableAllRowButtons() {
      const buttons = document.querySelectorAll('#movieTable button.action-btn');
      buttons.forEach(btn => {
        btn.disabled = false;
      });
    }
    // Toggle dark/light mode
    document.getElementById('toggleMode').addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const btn = document.getElementById('toggleMode');
      btn.textContent = document.body.classList.contains('dark-mode') ? 'Light Mode' : 'Night Mode';
    });
    // Note: do not attach a separate submit handler here; the unified form
    // submission logic is defined below in the onsubmit handler.  Having
    // multiple handlers causes duplicate requests and breaks edit logic.
    // Load movies
    async function loadMovies() {
      const search = document.getElementById('search').value;
      const sort = document.getElementById('sort').value;
      let url = `${API_BASE}/movies/?`;
      if (search) url += `search=${encodeURIComponent(search)}&`;
      if (sort) url += `sort_by=${encodeURIComponent(sort)}`;
      const res = await fetch(url);
      if (res.ok) {
        const movies = await res.json();
        const tbody = document.querySelector('#movieTable tbody');
        tbody.innerHTML = '';
        movies.forEach((movie) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${movie.id}</td>
            <td>${movie.title}</td>
            <td>${movie.director}</td>
            <td>${movie.year}</td>
            <td>${movie.rating ?? ''}</td>
            <td>${movie.watched}</td>
            <td><a href="https://www.imdb.com/find?q=${encodeURIComponent(movie.title)}" target="_blank">Search</a></td>
            <td>
              <button class="action-btn" onclick="enableRowEdit(this, ${movie.id}, '${encodeURIComponent(movie.title)}', '${encodeURIComponent(movie.director)}', ${movie.year}, ${movie.rating ?? 'null'}, ${movie.watched})">Edit</button>
              <button class="action-btn" onclick="deleteMovie(${movie.id})">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }
    }
    document.getElementById('loadMovies').addEventListener('click', loadMovies);
    // Delete movie
    async function deleteMovie(id) {
      // Ask for confirmation before deleting
      if (!confirm('Are you sure you want to delete this movie?')) return;
      const res = await fetch(`${API_BASE}/movies/${id}`, { method: 'DELETE' });
      if (res.ok) loadMovies();
    }
    // Enable inline editing for a row.  Replaces the row's cells with input
    // fields and swaps action buttons for Save/Cancel.
    window.enableRowEdit = function (btn, id, encTitle, encDirector, year, rating, watched) {
      if (editingRowId !== null) return; // only allow one row in edit mode
      editingRowId = id;
      // locate the row via the clicked button
      const row = btn.closest('tr');
      editingRowElement = row;
      const title = decodeURIComponent(encTitle);
      const director = decodeURIComponent(encDirector);
      const ratingVal = (rating !== null && rating !== 'null') ? rating : '';
      // Replace cells with inputs
      row.cells[1].innerHTML = `<input type="text" id="edit-title" value="${title}">`;
      row.cells[2].innerHTML = `<input type="text" id="edit-director" value="${director}">`;
      row.cells[3].innerHTML = `<input type="number" id="edit-year" value="${year}">`;
      row.cells[4].innerHTML = `<input type="number" step="0.1" id="edit-rating" value="${ratingVal}">`;
      row.cells[5].innerHTML = `<input type="checkbox" id="edit-watched" ${watched ? 'checked' : ''}>`;
      // Replace actions with Save and Cancel buttons
      row.cells[7].innerHTML = `
        <button class="action-btn" onclick="saveRowEdit(${id})">Save</button>
        <button class="action-btn" onclick="cancelRowEdit()">Cancel</button>
      `;

      // Disable edit/delete buttons on other rows while editing
      disableOtherRowButtons(row);
    };

    // Save inline edits for a row
    window.saveRowEdit = async function (id) {
      if (editingRowId !== id) return;
      const updated = {
        title: document.getElementById('edit-title').value,
        director: document.getElementById('edit-director').value,
        year: parseInt(document.getElementById('edit-year').value, 10),
        watched: document.getElementById('edit-watched').checked,
      };
      const ratingVal = document.getElementById('edit-rating').value;
      if (ratingVal) updated.rating = parseFloat(ratingVal);
      const res = await fetch(`${API_BASE}/movies/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updated),
      });
      if (res.ok) {
        editingRowId = null;
        editingRowElement = null;
        // Re-enable all row buttons after saving
        enableAllRowButtons();
        loadMovies();
      }
    };

    // Cancel inline edit and reload list
    window.cancelRowEdit = function () {
      editingRowId = null;
      editingRowElement = null;
      // Re-enable all buttons before reloading the list
      enableAllRowButtons();
      loadMovies();
    };
    // Intercept form submission
    document.getElementById('addForm').onsubmit = async function (e) {
      e.preventDefault();
      // Always create a new movie from the top form; inline editing is handled separately
      const movie = {
        title: document.getElementById('title').value,
        director: document.getElementById('director').value,
        year: parseInt(document.getElementById('year').value, 10),
        watched: document.getElementById('watched').checked,
      };
      const ratingVal = document.getElementById('rating').value;
      if (ratingVal) movie.rating = parseFloat(ratingVal);
      const response = await fetch(`${API_BASE}/movies/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(movie),
      });
      if (response.ok) {
        document.getElementById('addForm').reset();
        loadMovies();
        // Ensure button text says Add after a successful create
        const submitBtn = document.querySelector('#addForm button[type="submit"]');
        if (submitBtn) submitBtn.textContent = 'Add';
      }
    };
    // Initial load
    loadMovies();
  </script>
</body>
</html>